{"version":3,"sources":["../src/QiniuPlugin.js"],"names":["QiniuPlugin","options","ACCESS_KEY","SECRET_KEY","Error","Object","assign","qiniu","conf","compiler","plugin","compilation","callback","assets","hash","bucket","include","path","replace","promises","keys","filter","fileName","valid","emitted","some","includeFileName","RegExp","test","map","key","putPolicy","rs","PutPolicy","token","extra","io","PutExtra","promise","Promise","resolve","reject","begin","Date","now","console","log","JSON","stringify","putFile","existsAt","err","ret","duration","reduce","p","p2","then","res","catch","e"],"mappings":"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","file":"QiniuPlugin.js","sourcesContent":["import qiniu from 'qiniu';\nimport Promise from 'promise';\nimport { join } from 'path';\nimport slash from 'slash';\n\nclass QiniuPlugin {\n\n  constructor(options) {\n    if (!options || !options.ACCESS_KEY || !options.SECRET_KEY) {\n      throw new Error('ACCESS_KEY and SECRET_KEY must be provided');\n    }\n    this.options = Object.assign({}, options);\n    qiniu.conf.ACCESS_KEY = this.options.ACCESS_KEY;\n    qiniu.conf.SECRET_KEY = this.options.SECRET_KEY;\n  }\n\n  apply(compiler) {\n    compiler.plugin('after-emit', (compilation, callback) => {\n      const assets = compilation.assets;\n      const hash = compilation.hash;\n      const {\n        bucket,\n        include,\n      } = this.options;\n      let {\n        path = '[hash]',\n      } = this.options;\n\n      path = path.replace('[hash]', hash);\n\n      const promises = Object.keys(assets).filter((fileName) => {\n        let valid = assets[fileName].emitted;\n        if (include) {\n          valid = valid\n            && include.some(\n              (includeFileName) => {\n                if (includeFileName instanceof RegExp) {\n                  return includeFileName.test(fileName);\n                }\n                return includeFileName === fileName;\n              },\n            );\n        }\n        return valid;\n      }).map((fileName) => {\n        const key = slash(join(path, fileName));\n        const putPolicy = new qiniu.rs.PutPolicy(`${bucket}:${key}`);\n        const token = putPolicy.token();\n        const extra = new qiniu.io.PutExtra();\n\n        return () => {\n          const promise = new Promise((resolve, reject) => {\n            const begin = Date.now();\n            console.log('upload key: ' + JSON.stringify(key, null, 4) + '\\n');\n            qiniu.io.putFile(token, key, assets[fileName].existsAt, extra, (err, ret) => {\n              if (!err) {\n                resolve({\n                  ...ret,\n                  duration: Date.now() - begin,\n                });\n              } else {\n                reject(err);\n              }\n            });\n          });\n\n          return promise;\n        };\n      });\n\n      promises.reduce((p, p2) => p.then(() => p2()), Promise.resolve())\n        .then((res) => {\n          console.log(res); // eslint-disable-line no-console\n          callback();\n        })\n        .catch((e) => {\n          callback(e);\n        });\n    });\n  }\n}\n\nexport default QiniuPlugin;\n"]}